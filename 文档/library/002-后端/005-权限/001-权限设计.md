# 权限系统
独立的、公共的用户权限管理系统，限制用户对资源的访问，避免因权限控制缺失或操作不当引发的风险问题，支持多种不同应用的接入，也可以基于此系统提供的服务做定制化的二次开发。
## RBAC
系统整体的实现思想是RBAC，即基于角色的访问控制。所谓“角色”就是一个或一群用户在系统中可执行操作的集合，它是一个用户的集合，又是一个授权许可的集合。通过将角色指派给用户，为角色赋予权限的方式，使用户和权限通过角色间接相联系，在RBAC中，用户与角色之间、角色与权限之间都是多对多的关系。RBAC模型图

![](assets/002/005/001-1586759012836.png)
### 对RBAC的扩展
依据RBAC模型思想，此权限系统业务模型设计为员工管理和权限管理两部分，员工管理主要指管理员工以及为员工分配角色，权限管理主要指管理菜单、页面、按钮、API等资源，通过定义最基本的业务功能点，实现管理角色对资源主体的请求，构成“用户-角色-权限-资源”的授权模型。

![](assets/002/005/001-1586759158181.png)

## 系统中的名词解释
### 用户
系统中涉及的用户分三类：
1. 系统用户：角色的载体，权限的实行者
2. 系统管理员：负责给系统用户分配相关角色
3. 开发人员：需要维护一些基础数据，比如功能点和功能集

### 角色
用户和功能集的之间桥梁，从功能集角度，每个角色都是功能集的映射；从用户角度，拥有相同功能集的用户，他们属于同一个角色。
用户通过成为适当角色成员而得到这些角色的权限，角色可依新的需求和系统的合并而赋予新的权限，而权限也可根据需要而从某角色中回收。RBAC相对于传统访问控制更为中性且更具灵活性的存取控制技术，实现了用户与访问权限的逻辑分离。
### 功能点
逻辑上定义的用来描述系统资源的最小基本单位，系统上每个资源都是一个功能点，具有以下属性

类型：为了描述方便，可以把功能点分为菜单，页面，按钮，API，其中菜单有“等级”属性，表示几级菜单

资源码：通过不重复的资源码表示资源的全局唯一性，需要和前台页面对每个资源定义的资源码保持一致，方便渲染

坐标（idx,pos）：每个功能点占long类型数据（64位）中的一个位置
### 功能集
表示用户在系统上能做“哪些事”，一件事可能需要多个系统资源，比如，“新增用户”需要“新增按钮”、“新增页面”、“保存按钮”等系统资源，所以是功能点的聚合

拥有哪些功能点的表示方法：利用64位（long类型）二进制表示对功能点状态的描述，1表示有，0表示没有，这个long类型作为功能集属性，比如，“1100”表示该功能集有(0,0)，(0,1)这两个功能点

将功能集分为两类，资源功能集和API功能集
1. 资源功能集：这类功能集表示用户能看到自己能做“哪些事”，功能集之前存在上下级关系（有父id属性），比如“新增用户”功能集是“用户管理”功能集的下级
2. API功能集：这类功能集表示用户能执行“哪些事”，通过资源编码和按钮（最后会触发这个动作的资源功能集）绑定到一起

### 用户组
和角色的作用类似，可以分配给用户哪些功能集。首先给用户组分配功能集或角色，然后把有相同功能集的用户添加进来，添加进来的用户自动获取用户组配置的功能集。
和角色相比，用户组更具临时性（给用户临时扩展某些功能集），灵活性，扩展性，使管理员对用户--功能集的操作更加便捷。
这些名词的关系如下图：

![](assets/002/005/001-1586761342411.png)

用户同时拥有多个角色和用户组，用户组同时拥有多个角色和功能集。系统用户最终拥有的功能权限 = 用户角色拥有的权限 + 该用户所在用户组拥有的权限
## 权限系统模型的实现
### 将功能集转成二进制
问题：在传统的RBAC模型中，通常通过一张关系表来保存角色与权限集的对应关系，实现权限与角色相关联。可以预见的是，随着业务的不断发展，角色和功能集关系表，功能集和功能点关系表的数据量不断增长，导致维护困难。

思想：利用进制转换的策略解决了这个问题，利用一个Long类型的十进制表示功能集，也可以看做是由64位0或1组成的二进制。而64位中的每一位都对应一个功能点，每一个功能点是由idx和pos两个属性确保全局唯一（idx表示第几个Long型空间，pos表示Long型对应的二进制数中所处的位置），64位长度即可代表64个不同能功能点。当64位满时无法再容放更多的功能点，这时idx属性会自增，重新申请一个Long型空间。如此一个64位的Long数字，通过0或1的组合，即可表示最多对64个不同的功能点所拥有权限的状态描述。提高了存储效率以及权限判定效率

功能集换算公式：{(idx0,pos0),(idx0,pos1)…(idxN,posM)} => {Long0,Long1…LongN}

比如：
定义如下功能点：

| idx | pos | 名称
| :------: | :------: | :------:
| 0 | 0 | 订单管理（页面）
| 0 | 1 | 查看订单（按钮）
| 0 | 2 | 商品管理（页面）
| 0 | 3 | 新增商品（按钮）
| 0 | 4 | 新增商品（API）
| 0 | 5 | 订单模块（菜单）

功能集：
1. 订单管理，拥有“订单管理”和“订单模块”两个功能点，转化为二进制为：(0,0),(0,5) ——> 100001......
2. 新增商品，拥有“新增商品（按钮）”和“新增商品（API）”两个功能点，转化为二进制为：(0,3),(0,4) ——> 000110......
3. 查看订单，拥有“查看订单（按钮）”功能点，转化为二进制为：(0,1) ——> 010000......

角色：

创建“收银员”角色，并给角色分配了“订单管理”和“查看订单”两个功能集，角色的功能集为：100001...... | 010000...... = 110001......

### 权限验证
通过权限校验计算公式——进制按位“与”运算操作的思想得出该角色是否拥有访问资源的权限。采用进制来实现运算，权限判定的效率会变得更加的高效

{Long0,Long1…LongN} & {Long0,Long1…LongM} 

比如：验证“收银员”角色是否具有查看订单权限

110001 & 010000 = 010000 结果和“查看订单”的功能集相同，说明有权限

### 菜单渲染

返回用户能看到的“哪些事”，操作的是资源功能集
1. 角色的功能集先和一级功能集进行按位与计算
2. 再和一级功能集下的结点进行按位与计算

最终的结果就是该角色可以看到的菜单树

比如，要渲染如下页面：

![](assets/002/005/001-1586938706840.png)

对应的功能集为：“会员账号”和“新增”

![](assets/002/005/001-1586770103537.png)

1. 用户角色的功能集和“会员账号”按位与，判断是否有权限
2. 用户角色的功能集和“新增”按位与，判断是否有权限
3. 查询功能集下功能点，并组装成树形结构返回（根据前端需要的数据格式可选）

结合以上两步的结果，把功能集组装成树形结构返回，如果前端需要会员账号的上级菜单，或新增按钮的页面元素等，则需要第三步

### API验证

角色的功能集和API的功能集按位与操作

## 给系统用户分配权限流程
1. 维护功能点（开发人员）
2. 维护功能集（开发人员）
3. 维护角色（系统管理员）
4. 维护用户组（系统管理员）
5. 给系统用户分配角色（系统管理员）

## 验证系统用户的权限流程
1.	系统用户登录，登录接口返回该用户所有菜单
2.	前台判断用户是否具备“菜单”，“页面”，“按钮”等功能，有则显示，没有不显示
3.	请求后台API时，后台验证用户具有这个API功能

![](assets/002/005/001-1586771212725.png)

## 模块功能
### 业务分类
业务分类维护；增，删，改，查
### 功能点
后台开发人员维护

新增：选择业务分类和父结点，手填功能点的坐标（idx，pos）不能和已有功能点重复

修改，删除，查询
### 功能集（资源，API）
后台开发人员维护
新增：选择功能点后新增（功能点的选择要结合实际业务场景）

比如：应用系统中给角色配置权限采用如下设计

![](assets/002/005/001-1586770062051.png)

为满足以上需求，功能集应维护成这样：

![](assets/002/005/001-1586770103537.png)

当用户选择“会员账号”“新增”时，就拥有这两个功能集的所有权限了

功能点转功能集

功能集转功能点
### 角色
新增：选择多个功能集

删除：如果角色被使用（已分配给用户）则不能删除

修改功能集：对已具有的功能集取消勾选，或为某功能集添加勾选，来修改角色的功能集，点击“保存”按钮保存修改信息。

给角色添加用户：点击某个角色，选择多个用户，实现给批量用户授予角色的目的

查询某个角色拥有哪些功能集

### 用户组
添加成员：选择用户，添加。

分配功能集：列出系统中的所有功能，选择添加。

分配角色：

编辑：只能修改组的基本信息，比如，组名称，描述。

删除：删除一个用户组，同时删除组内用户，和该用户组的功能权限

新增：新增一个用户组。

查询用户功能集

### 用户
配置角色：列出系统中的所有角色，勾选保存。

申请加入用户组

查询用户的功能集

## 程序架构设计
基于 DDD（领域驱动模型）程序设计思想实现功能，基于 rpc 协议的框架，对外提供服务接口。整体架构如下图：

![](assets/002/005/001-1586772834535.png)

service层：对外提供rpc协议接口

domain层：定义需要的类，属性，方法（面向对象思想）

repository层：数据访问层

tunnel层：数据存储的接口层，可以有不同的落地实现方式
## 系统架构设计

![](assets/002/005/001-1586775346965.png)

## UML类图

## 数据库设计

![](assets/002/005/001-1586939762728.png)